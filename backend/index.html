<html>
<head>
<link rel="stylesheet" type="text/css" href="static/style.css" />
    <title>Instaright Realtime updates</title>
    
    <script src="http://www.google.com/jsapi?key=AIzaSyDu78p4P0qEe3CTU4GssVBz_crZemld_eg" type="text/javascript" charset="utf-8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
    </script>
    <script src="/_ah/channel/jsapi"></script>

    <script type="text/javascript" charset="utf-8">
	$(function() {
		function runEffect(){
			options = {};
			$("#effect").show("Blind", options, 500, callback);
			
		};

		function callback(){
			alert('right?');
		}

	});

      // NOTE: we are using channel API instead of version v2 of the Feed API
      google.load('feeds', '1');
      // Set a callback to load your code when the page loads.
      google.setOnLoadCallback(init);

      // Create variables to display subscription options using HTML DIVs
      var stream;

      // Initialize the API.
      var feed;
      function init() {

	      // This example works with one feed subscription. The feed displays in
	      // in the display div. The following code sets up the feed for that div.
	      stream = document.getElementById('stream');
	      stream.innerHTML = '';

	      // Load a feed. We created the feed in this example using

	      var feed = new google.feeds.Feed('http://instaright.appspot.com/feed');
	      feed.setNumEntries(10);
	      // Enable subscriptions to the feed.
	      feed.load(entryLoaded);
      }
      
      // Create a callback function for google.feeds.push.Feed.subscribe()
      // and load it into the display DIV.
      function entryLoaded(response) {
        displayEntry(response, stream);
      }
      function updateDisplayEntry(response, div) {
        entries = response.getElementsByTagName('entry')
        for (var i = 0; i < entries.length; i++) {
	  try{
		  var entry = entries[i];
		  var title = entry.getElementsByTagName("title")[0].firstChild.nodeValue;
		  var link = entry.getElementsByTagName("link")[0].getAttribute('href');
		  var dateUpdated = new Date(entry.getElementsByTagName("updated")[0].firstChild.nodeValue);

		  var container = document.createElement('div');
		  container.setAttribute('class', 'streamcontent');
		  $("#streamcontent").hide();
		  var anchor = document.createElement('a');
		  anchor.innerHTML = title;
		  anchor.href = link;
		  container.appendChild(anchor);
		  container.appendChild(document.createElement('br'));
		  var contentParagraph = document.createElement('p');
		  contentParagraph.innerHTML = dateUpdated;
		  container.appendChild(contentParagraph);
		  container.appendChild(document.createElement('br'));
		  container.appendChild(document.createElement('br'));
		  div.insertBefore(container, div.firstChild);
		  runEffect();

	 }catch(e){
		alert("while adding new element :" +e);
	 }
        }
      }

      // Specify the result objects to display with feed results.
      function displayEntry(response, div) {
        feed = response.feed;
        var entries = feed.entries;
        entries = entries.reverse();
        for (var i = 0; i < entries.length; i++) {
	  
          var entry = entries[i];
          var title = entry.title;
          var link = entry.link;
	  var dateUpdated = new Date(entry.publishedDate);
          var container = document.createElement('div');
	  container.setAttribute('class', 'streamcontent');
          var anchor = document.createElement('a');
          anchor.innerHTML = title;
          anchor.href = link;
          container.appendChild(anchor);
          container.appendChild(document.createElement('br'));
          var contentParagraph = document.createElement('p');
          contentParagraph.innerHTML = dateUpdated;
          container.appendChild(contentParagraph);
          container.appendChild(document.createElement('br'));
          container.appendChild(document.createElement('br'));
          div.insertBefore(container, div.firstChild);
        }
      }
	var channel_id= "{{ channel_id }}";
	var channel = new goog.appengine.Channel(channel_id);
	var socket = channel.open();
	socket.onopen = function(){
		alert('connected');
	}
	socket.onmessage = function(evt){
	        stream = document.getElementById('stream');
		feed_update =(new DOMParser()).parseFromString(evt.data, "text/xml");
		updateDisplayEntry(feed_update, stream);
	};
	function sendinvite(){
		if( !window.XMLHttpRequest ) XMLHttpRequest = function()
		{
			try{ return new ActiveXObject("Msxml2.XMLHTTP.6.0") }catch(e){}
			try{ return new ActiveXObject("Msxml2.XMLHTTP.3.0") }catch(e){}
			try{ return new ActiveXObject("Msxml2.XMLHTTP") }catch(e){}
			try{ return new ActiveXObject("Microsoft.XMLHTTP") }catch(e){}
			throw new Error("Could not find an XMLHttpRequest alternative.")
		};
		try{
			invite_mail = document.getElementById("invite_mail");
			url = "/send_invite";
			req = XMLHttpRequest();
			req.open('POST', url);
			req.send(invite_mail.value);
			req.onreadystatechange =  function(){
				if ( req.readyState == 4 && req.status == 200){
					try{
						done_paragraph = document.createElement('p');
						done_paragraph.innerHTML = req.responseText;	
						appendTo = document.getElementById('submitImg');
						appendTo.appendChild(done_paragraph);
					}catch(e){
							alert('e:'+e);
						}
				}
			}
		} catch(e){
			alert('e:'+e);
		}
		
	}
    </script>
  </head>
  <body>
<div id="header" class="container_24">
	<div>
            <ul> 
		{% if user %}
                <li>Hi {{ user }}</li>
		{% else %}
                <li><a id="btn_login" href="{{ login_url }}" title="Login">introduce yourself</a></li>
		{% endif %}
		
            </ul>
        </div>
</div>
<div class="wrapper"> 
<div id="logo_bar"> 
    <div id="header" class="container_24"> 
        <!--div class="grid_7 alpha"--> 
            <h1 id="logo"><a href="/" title="Instaright">Instaright</a></h1> 
        <!--/div--> 
    </div> 
</div> 
<div class="clear"></div> 
<div id="content" class="container_24"> 
    <div id="left_col" class="grid_18"> 
        
        <div class="left_box_top"> 
            <h2 class="round_title"> 
                <span>Instaright Stream</span> 
            </h2> 
        </div> 
        
        <div class="left_box_mid"> 
	<style> 
	#streammap{
    		border:8px solid #FFFFFF;
  		height:230px;
    		margin:0px 0px 10px 0px;
    		width:660px;
	}
	.scan, .streamcontent {
    		-moz-border-radius:15px;
    		border:1px solid #ADA699;
    		clear:both;
    		display:block;
    		margin:10px 0px 10px 0px;
    		padding:10px;
    		text-decoration:none;
	}
	</style>
        <div id="stream"></div>
       	</div>
	<div class="left_box_bot"></div> 
   </div>
   <div id="right_col" class="grid_6">
	<input type="text" id="invite_mail">
	<img link="/static/submit.ico" onclick="sendinvite();" id="submitImg"/>
   </div>
</div>
<div class="clear"></div> 
</div>
<div class="push"></div> 
</div> 
<div class="clearfix"></div> 
</div>
 
<div id="foot_wrap" style="margin-top:100px;">  
<div id="foot" class="container_24"> 
</div>
<div class="clear"></div> 
</div>
  </body>
</html>
