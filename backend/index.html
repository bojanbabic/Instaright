<!-- Google Website Optimizer Control Script -->
<script>
        function utmx_section(){}function utmx(){}
        (function(){var k='2188815013',d=document,l=d.location,c=d.cookie;function f(n){
                        if(c){var i=c.indexOf(n+'=');if(i>-1){var j=c.indexOf(';',i);return c.substring(i+n.
                                        length+1,j<0?c.length:j)}}}var x=f('__utmx'),xx=f('__utmxx'),h=l.hash;
                d.write('<sc'+'ript src="'+
                'http'+(l.protocol=='https:'?'s://ssl':'://www')+'.google-analytics.com'
                +'/siteopt.js?v=1&utmxkey='+k+'&utmx='+(x?x:'')+'&utmxx='+(xx?xx:'')+'&utmxtime='
                +new Date().valueOf()+(h?'&utmxhash='+escape(h.substr(1)):'')+
                '" type="text/javascript" charset="utf-8"></sc'+'ript>')})();
</script><script>utmx("url",'A/B');</script>
<!-- End of Google Website Optimizer Control Script -->
<html>
        <head>
                <link rel="stylesheet" type="text/css" href="css/style.css" />
                <script src="http://www.google.com/jsapi?key=AIzaSyDu78p4P0qEe3CTU4GssVBz_crZemld_eg" type="text/javascript" charset="utf-8"></script>
                <script src='/_ah/channel/jsapi'></script>
                <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
                <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
                <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
                <title>Instaright Realtime Stream</title>

                <!-- google analytics -->
                <script type="text/javascript">

                        var _gaq = _gaq || [];
                        _gaq.push(['_setAccount', 'UA-9005862-5']);
                        _gaq.push(['_trackPageview']);

                        (function() {
                         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                         })();
                 </script>
                 <!-- Google Website Optimizer Tracking Script -->

         </head>
         <body>
                 <script type="text/javascript" charset="utf-8">
                         if( !window.XMLHttpRequest ) XMLHttpRequest = function()
{
        try{ return new ActiveXObject("Msxml2.XMLHTTP.6.0") }catch(e){}
        try{ return new ActiveXObject("Msxml2.XMLHTTP.3.0") }catch(e){}
        try{ return new ActiveXObject("Msxml2.XMLHTTP") }catch(e){}
        try{ return new ActiveXObject("Microsoft.XMLHTTP") }catch(e){}
        throw new Error("Could not find an XMLHttpRequest alternative.")
};
var channel_id= '{{ channel_id }}';
var channel = new goog.appengine.Channel(channel_id);
var socket = channel.open();
var maxElementsInStream=4;
socket.onopen = function(){
        //alert('connected');
}
socket.onmessage = function(evt){
        //alert('on message');
        try{
                //alert('evt data:' + evt.data);
                feed_json_update = JSON.parse(evt.data);
                //alert(feed_json_update);
                updateDisplayEntry(feed_json_update, stream);
        } catch(e){
                //alert('eee:'+e);
        } 
};


// NOTE: we are using channel API instead of version v2 of the Feed API
google.load('feeds', '1');
// Set a callback to load your code when the page loads.
google.setOnLoadCallback(init);
$(document).ready(function(){
                $("#jid_result").hide();
                //$("#invite_jid").focus();
                //alert('instaright_id:'+com.appspot.model.account);
                });

// Create variables to display subscription options using HTML DIVs

var stream = document.getElementById('stream');

// Initialize the API.
var feed;
function check_and_send_jid(){
        jid= $("#invite_jid").val();     
        if (jid.indexOf("@") == -1 || jid.indexOf(" ") != -1){
                $("#jid_result").html("<b>not valid jabber address</b>");
                $("#jid_result").show();
        }
        else{
                send_invite();
                $("#jid_result").html("<b>Message sent. you will receive IM from instaright@appspot.com</b>");
                $("#jid_result").show();
        }
        $("#jid_result").delay(2000).fadeOut('slow');
        $("#invite_jid").val('');     
}

function init(){
        /*  try{
            url = "/feed?format=json";
            req = XMLHttpRequest();
            req.open('GET', url);
            req.onreadystatechange = function(){
            if (req.status == 200){
            alert(req.responseText);
            }
            }
            req.send(null);
            } catch(e){
            }*/
        $("#invite_jid").bind('keypress', function(e){
                        if (e.keyCode == 13){
                        check_and_send_jid();
                        }
                        });
        $("#invite_jid").focus(function(){
                        $(this).val("");
                        });
        feed = new google.feeds.Feed('http://instaright.appspot.com/feed');
        feed.setNumEntries(10);
        // Enable subscriptions to the feed.
        feed.load(entryLoaded);

}
function entryLoaded(response) {
        displayEntry(response);
}

function displayEntry(response) {
        feed = response.feed;
        div = document.getElementById('stream');
        var entries = feed.entries;
        entries = entries.reverse();
        maxElements = entries.length;
        if (maxElements >=  maxElementsInStream){
                maxElements = maxElementsInStream;
        }
        for (var i = 0; i < maxElements; i++) {

                var entry = entries[i];
                var title = entry.title;
                var link = entry.link;
                var dateUpdated = new Date(entry.publishedDate);
                var container = document.createElement('div');
                container.setAttribute('class', 'streamcontent');
                containerAvatar = document.createElement('div');


                avatarElement = document.createElement('img');
                avatarElement.setAttribute('src', '/static/images/noavatar.png');
                avatarElement.setAttribute('class', 'avatar');

                containerAvatar.appendChild(avatarElement);
                container.appendChild(containerAvatar);
                var anchor = document.createElement('a');
                anchor.innerHTML = title;
                anchor.href = link;
                container.appendChild(anchor);
                container.appendChild(document.createElement('br'));
                var contentParagraph = document.createElement('p');
                contentParagraph.innerHTML = dateUpdated;
                container.appendChild(contentParagraph);
                container.appendChild(document.createElement('br'));
                container.appendChild(document.createElement('br'));
                div.insertBefore(container, div.firstChild);
        }
}

function updateDisplayEntry(response, div) {
        try{
                div = document.getElementById('stream');
                //alert('length:' + response.length);
                for (i = 0; i < response.length; i++) {
                        e = response[i]['u'];
                        title = e['t'];
                        link = e['l'];
                        dateUpdated = new Date(e['u']);
                        id = e['id'];

                        container = document.createElement('div');
                        containerAvatar = document.createElement('div');


                        avatarElement = document.createElement('img');
                        avatarElement.setAttribute('src', '/static/images/noavatar.png');
                        avatarElement.setAttribute('class', 'avatar');

                        containerAvatar.appendChild(avatarElement);
                        container.setAttribute('class', 'streamcontent');
                        container.setAttribute('id', id);
                        anchor = document.createElement('a');
                        anchor.innerHTML = title;
                        anchor.href = link;

                        container.appendChild(containerAvatar);
                        container.appendChild(anchor);
                        container.appendChild(document.createElement('br'));
                        contentParagraph = document.createElement('p');
                        contentParagraph.innerHTML = dateUpdated;
                        container.appendChild(contentParagraph);
                        container.appendChild(document.createElement('br'));
                        container.appendChild(document.createElement('br'));
                        div.insertBefore(container, div.firstChild);
                        $("#"+id).hide();
                        $("#"+id).show('blind');
                        sElements = $("#stream").children();
                        if (sElements.length > maxElementsInStream ){
                                lastElement = sElements.get(-1); 
                                last_id = lastElement.getAttribute('id');
                                //alert('id:'+ id);
                                $("#"+last_id).hide();
                                div.removeChild(lastElement)
                        }
                }

        }catch(e){
                alert("while adding new element :" +e);
        }
}
function send_invite(){
        try{
                $.post("/send_invite", $("#invite_jid").val());
        } catch(e){
                alert('e:'+e);
        }

}
</script>


<div id="header" class="container_24">
        <div style="text-align: right;">
                <ul> 
                        {% if user %}
                        <li>Hi {{ user }}</li>
                        {% else %}
                        <li><a id="btn_login" href="{{ login_url }}" title="Login">introduce yourself</a></li>
                        {% endif %}

                </ul>
        </div>
</div>
<div class="wrapper"> 
        <div id="content" class="container_24"> 
                <div id="left_col" class="grid_18"> 
                        <div class="left_box_top"> 
                                <h2 class="round_title"> 
                                        <span>Instaright Stream</span> 
                                </h2> 
                        </div> 
                        <div class="left_box_mid"> 
                                <style> 
                                        #streammap{
                                                border:8px solid #ffffff;
                                                height:230px;
                                                margin:0px 0px 10px 0px;
                                                width:660px;
                                        }
                                        .scan, .streamcontent {
                                                -moz-border-radius:15px;
                                                border:1px solid #ADA699;
                                                clear:both;
                                                display:block;
                                                margin:10px 0px 10px 0px;
                                                padding:10px;
                                                text-decoration:none;
                                        }
                                </style>
                                <div id="stream"></div>
                        </div>
                        <div class="left_box_bot"></div> 
                </div>
                <div id="right_col" class="grid_6">
                        <div id="right_box_top">
                                <p style="text-align: center;">Instaright Firefox addon</p>
                                <p style="text-align: center;"><a title="Instapaper firefox addon" href="https://addons.mozilla.org/en-US/firefox/addon/13317/"><img src="static/images/install_now.png" style="width:220px; height: 60px;" alt="Instapaper firefox addon"/></a></p>
                                <p class="social_media">Realtime tracking</p>
                                <div class="text-align: center; width: 270px;">
                                        Track domains on Instaright in realtime<br>
                                        on your favorite client.
                                        <p id="jabbers">
                                        <img src="/static/images/messenger.png"/><img src="/static/images/gtalk.png"/><img src="/static/images/aim.png"/></p>
                                        </div><p></p><div>
                                        <p>To get started enter your jabber id and wait for invite from our bot and <span style="color:#0066CC;">press Enter</span></p>

                                        <input type="text" id="invite_jid" value="Enter your jabber id" />
                                        <div id="jid_result" style="text-align: center; "></div>
                                        <p></p>
                                </div>
                        </div>
                        <div id="right_box_mid">
                                <ul>
                                        <li class="social_media"><img align="left" src="/static/images/twitter.png"/><a href="http://twitter.com/instaright">Twitter</a></li>
                                        <li class="social_media"><img align="left" src="/static/images/facebook.png"/><a href="http://www.facebook.com/pages/Instaright-Firefox-addon-for-Instapapaer/105396136190038">Facebook Page</a></li>
                                        <li class="social_media"><img align="left" src="/static/images/blog.png"/><a href="http://instaright.tumblr.com/">Blog</a></li>
                                        <li class="social_media"><img align="left" src="/static/images/stats_2.png"/><a href="/stats">Stats</a></li>
                                </ul>
                        </div>
                        <div id="right_box_bot">
                                <div>

                                </div>

                        </div>
                </div>
        </div>
        <div class="clear"></div> 
        <div class="push"></div> 
</div>
<div class="clearfix"></div> 
</div>

<div class="footer-container">
        <div style="position: relative; text-align: center; color: rgb(0, 0, 204); font-size: small;">
                <p><a href="mailto:gbabun@gmail.com">contact</a> | <a href="http://twitter.com/bojanbabic">twitter</a> | <a href="http://bojanbabic.blogspot.com">blog</a></p>
        </div>
</div>
<!-- GETSATISFACTION -->
<script type="text/javascript" charset="utf-8">
        var is_ssl = ("https:" == document.location.protocol);
        var asset_host = is_ssl ? "https://s3.amazonaws.com/getsatisfaction.com/" : "http://s3.amazonaws.com/getsatisfaction.com/";
        document.write(unescape("%3Cscript src='" + asset_host + "javascripts/feedback-v2.js' type='text/javascript'%3E%3C/script%3E"));
        </script>

        <script type="text/javascript" charset="utf-8">
                var feedback_widget_options = {};

feedback_widget_options.display = "overlay";  
feedback_widget_options.company = "instaright";
feedback_widget_options.placement = "left";
feedback_widget_options.color = "#222";
feedback_widget_options.style = "idea";
var feedback_widget = new GSFN.feedback_widget(feedback_widget_options);
</script>
<!-- End GETSATISFACTION -->
<!-- Google Website Optimizer Tracking Script -->
<script type="text/javascript">
        if(typeof(_gat)!='object')document.write('<sc'+'ript src="http'+
                        (document.location.protocol=='https:'?'s://ssl':'://www')+
                        '.google-analytics.com/ga.js"></sc'+'ript>')</script>
                <script type="text/javascript">
                        try {
                                var gwoTracker=_gat._getTracker("UA-9005862-6");
                                gwoTracker._trackPageview("/2188815013/test");
                                }catch(err){}
                </script>
<!-- End of Google Website Optimizer Tracking Script -->
<!-- Begin Survey.io code for . -->
                <script src="http://cdn.survey.io/embed/1.0/survey.js" type="text/javascript"></script>
                <script type="text/javascript" charset="utf-8">
                        Surveyio.init({
survey_id: "396ea",
token: "a787ed2e15426c0d99b9b9ce5d130a20feb62c91",
banner: {
x: "right",
y: "bottom",
color: "blue"
}
});
</script>
<!-- /End Survey.io code -->

        </body>
</html>
